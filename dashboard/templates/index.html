{% extends "base.html" %}

{% block title %}AIA Analytics Dashboard{% endblock %}

{% block header %}Dashboard Overview{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-md">
                    <i class="lni lni-comments text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Total Conversations</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="total-conversations">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-md">
                    <i class="lni lni-bubble text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Total Messages</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="total-messages">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-md">
                    <i class="lni lni-users text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Active Agents</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="unique-agents">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-red-100 rounded-md">
                    <i class="lni lni-stats-up text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">AI Insights</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="ai-insights-count">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Sentiment Analysis -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">AI Sentiment Analysis</h3>
                <p class="text-sm text-gray-500">Customer sentiment trends from recent conversations</p>
            </div>
            <div class="p-6">
                <canvas id="sentimentChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent AI Insights -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Recent AI Insights</h3>
                <p class="text-sm text-gray-500">Latest conversation analysis</p>
            </div>
            <div class="p-6">
                <div id="recent-insights" class="space-y-4">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Conversation Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Issue Resolution -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Issue Resolution</h3>
                <p class="text-sm text-gray-500">AI-analyzed resolution rates</p>
            </div>
            <div class="p-6">
                <canvas id="resolutionChart" width="300" height="200"></canvas>
            </div>
        </div>

        <!-- Product Interest -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Product Interest</h3>
                <p class="text-sm text-gray-500">Most discussed AIA products</p>
            </div>
            <div class="p-6">
                <div id="product-interest" class="space-y-3">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- AI Actions -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">AI Actions</h3>
                <p class="text-sm text-gray-500">Generate insights and reports</p>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="generateReport()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="lni lni-download mr-2"></i>
                    Generate AI Report
                </button>
                <button onclick="refreshInsights()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="lni lni-reload mr-2"></i>
                    Refresh AI Insights
                </button>
                <button onclick="viewProductOpportunities()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="lni lni-bulb mr-2"></i>
                    Product Opportunities
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Conversations Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Recent Conversations</h3>
                    <p class="text-sm text-gray-500">Latest customer interactions with AI analysis</p>
                </div>
                <a href="/conversations" class="text-red-600 hover:text-red-700 text-sm font-medium">
                    View All â†’
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversation ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Messages</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Sentiment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issues</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="conversations-table" class="bg-white divide-y divide-gray-200">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Product Opportunities Modal -->
<div id="opportunitiesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">AI Product Opportunities</h3>
                <button onclick="closeOpportunitiesModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="lni lni-close text-xl"></i>
                </button>
            </div>
            <div id="opportunities-content" class="max-h-96 overflow-y-auto">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let sentimentChart, resolutionChart;

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard-overview');
        const data = await response.json();
        
        // Update overview cards
        document.getElementById('total-conversations').textContent = data.total_conversations || 0;
        document.getElementById('total-messages').textContent = data.total_messages || 0;
        document.getElementById('unique-agents').textContent = data.unique_agents || 0;
        document.getElementById('ai-insights-count').textContent = data.ai_insights?.total_analyzed || 0;
        
        // Load AI insights
        if (data.ai_insights && data.ai_insights.sample_insights) {
            displayRecentInsights(data.ai_insights.sample_insights);
            createSentimentChart(data.ai_insights.sample_insights);
            createResolutionChart(data.ai_insights.sample_insights);
            displayProductInterest(data.ai_insights.sample_insights);
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Load conversations table
async function loadConversationsTable() {
    try {
        const response = await fetch('/api/conversations');
        const conversations = await response.json();
        
        const tbody = document.getElementById('conversations-table');
        tbody.innerHTML = conversations.slice(0, 10).map(conv => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${conv['Conversation ID']}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(conv['Start Time']).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${conv['Total Messages'] || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getSentimentColor(conv.AI_Sentiment)}">
                        ${conv.AI_Sentiment || 'unknown'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${conv.AI_Issues_Count || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(conv.AI_Status)}">
                        ${conv.AI_Status || 'unknown'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <a href="/conversation/${conv['Conversation ID']}" class="text-red-600 hover:text-red-700">
                        View Details
                    </a>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

function displayRecentInsights(insights) {
    const container = document.getElementById('recent-insights');
    container.innerHTML = insights.slice(0, 5).map(insight => `
        <div class="border-l-4 border-blue-400 pl-4">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-900">${insight.conversation_id}</p>
                    <p class="text-xs text-gray-500">${insight.customer_intent.substring(0, 80)}...</p>
                </div>
                <span class="px-2 py-1 text-xs font-medium rounded-full ${getSentimentColor(insight.sentiment)}">
                    ${insight.sentiment}
                </span>
            </div>
        </div>
    `).join('');
}

function createSentimentChart(insights) {
    const ctx = document.getElementById('sentimentChart').getContext('2d');
    
    const sentimentCounts = insights.reduce((acc, insight) => {
        acc[insight.sentiment] = (acc[insight.sentiment] || 0) + 1;
        return acc;
    }, {});
    
    if (sentimentChart) sentimentChart.destroy();
    
    sentimentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(sentimentCounts),
            datasets: [{
                data: Object.values(sentimentCounts),
                backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#6B7280'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createResolutionChart(insights) {
    const ctx = document.getElementById('resolutionChart').getContext('2d');
    
    const resolutionCounts = insights.reduce((acc, insight) => {
        acc[insight.resolution_status] = (acc[insight.resolution_status] || 0) + 1;
        return acc;
    }, {});
    
    if (resolutionChart) resolutionChart.destroy();
    
    resolutionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(resolutionCounts),
            datasets: [{
                data: Object.values(resolutionCounts),
                backgroundColor: '#DC2626',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function displayProductInterest(insights) {
    const container = document.getElementById('product-interest');
    
    // Count product mentions
    const productCounts = {};
    insights.forEach(insight => {
        insight.product_interest.forEach(product => {
            productCounts[product] = (productCounts[product] || 0) + 1;
        });
    });
    
    const sortedProducts = Object.entries(productCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
    
    container.innerHTML = sortedProducts.map(([product, count]) => `
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700">${product}</span>
            <span class="text-sm font-medium text-gray-900">${count}</span>
        </div>
    `).join('');
}

function getSentimentColor(sentiment) {
    switch (sentiment) {
        case 'positive': return 'bg-green-100 text-green-800';
        case 'negative': return 'bg-red-100 text-red-800';
        case 'neutral': return 'bg-yellow-100 text-yellow-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStatusColor(status) {
    switch (status) {
        case 'resolved': return 'bg-green-100 text-green-800';
        case 'partially_resolved': return 'bg-yellow-100 text-yellow-800';
        case 'unresolved': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

async function generateReport() {
    try {
        const response = await fetch('/api/generate-report');
        const result = await response.json();
        
        if (result.status === 'success') {
            alert(`AI Report generated successfully: ${result.filename}`);
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (error) {
        alert('Error generating report: ' + error.message);
    }
}

async function refreshInsights() {
    location.reload();
}

async function viewProductOpportunities() {
    try {
        const response = await fetch('/api/product-insights');
        const data = await response.json();
        
        const modal = document.getElementById('opportunitiesModal');
        const content = document.getElementById('opportunities-content');
        
        if (data.error) {
            content.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
        } else {
            content.innerHTML = `<div class="prose max-w-none">${data.opportunities_analysis.replace(/\n/g, '<br>')}</div>`;
        }
        
        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading product opportunities:', error);
    }
}

function closeOpportunitiesModal() {
    document.getElementById('opportunitiesModal').classList.add('hidden');
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadConversationsTable();
});
</script>
{% endblock %}
